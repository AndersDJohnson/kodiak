digraph Kodiak {

  "GitHub"[shape=doublecircle]

  "GitHub" -> "HTTP Webhook"[label="HTTP events", weight=0]

  subgraph cluster_kodiak {
    label = "Kodiak"

    "HTTP Webhook" -> Redis [label="add to per-repo ingest queue", weight=0]
    
    "Celery Beat" [shape=doubleoctagon]

    CBIngest [label="Celery Beat Ingest Worker"]
    "Celery Beat" -> CBIngest [label="create worker for all repos.\nprocess incoming event."]
    CBIngest -> Redis [label="(A) pull event"]
    CBIngest -> GitHub [label="(B) get mergeability info"]
    CBIngest -> Redis [label="(C) Add mergeable prs to merge queue"]
    
    "Celery Beat Worker" [label="Celery Beat Merge Worker"]
    "Celery Beat" -> "Celery Beat Worker" [label="create worker every few seconds for all repos"]
    "Celery Beat Worker" -> "Redis" [label="(2) pull pr for merging.\nestablish lock on repo. (acks late?)"]
    "Celery Beat Worker" -> Redis [label="(1) check for active PR for repo"]
    "Celery Beat Worker" -> "GitHub" [label="(3) fetch mergeability information"]
    "Celery Beat Worker" -> "GitHub" [label="(4) merge pr"]
    
    Redis [shape=cylinder, label="Redis \n(per-repo queues, active PR to merge)"]

  }

}
